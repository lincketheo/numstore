name: CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: gcc:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update -qq
          apt-get install -y -qq cmake make valgrind libbacktrace-dev

      - name: Build
        run: make comprehensive

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build/
          retention-days: 1

  test:
    runs-on: ubuntu-latest
    container:
      image: gcc:latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build/

      - name: Restore executable permissions
        run: |
          # Find all test executables and make them executable
          find ./build -type f -path "*/apps/test" -exec chmod +x {} \;

      - name: Install dependencies
        run: |
          apt-get update -qq
          apt-get install -y -qq valgrind libbacktrace-dev

      - name: Run tests
        run: |
          set -e  # Exit on first error

          # Find all test executables
          TEST_EXES=$(find ./build -type f -path "*/apps/test")

          if [ -z "$TEST_EXES" ]; then
            echo "ERROR: No test executables found matching ./build/**/apps/test"
            exit 1
          fi

          echo "Found test executables:"
          echo "$TEST_EXES"
          echo ""

          # Track if any test fails
          FAILED=0

          # Run each test executable under valgrind
          for TEST_EXE in $TEST_EXES; do
            BUILD_DIR=$(dirname "$TEST_EXE")
            echo "========================================"
            echo "Running valgrind on: $TEST_EXE"
            echo "Build directory: $BUILD_DIR"
            echo "========================================"

            cd "$BUILD_DIR"

            # Run valgrind with the same parameters as in Makefile
            if ! ./test; then
              echo "FAILED: test failed for $TEST_EXE"
              FAILED=1
            else
              echo "PASSED: Valgrind test passed for $TEST_EXE"
            fi

            echo ""
            cd - > /dev/null
          done

          # Exit with error if any test failed
          if [ $FAILED -ne 0 ]; then
            echo "========================================"
            echo "ERROR: One or more valgrind tests failed"
            echo "========================================"
            exit 1
          fi

          echo "========================================"
          echo "SUCCESS: All valgrind tests passed"
          echo "========================================"
